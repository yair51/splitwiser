{% extends "base.html" %}
{% block title %}{{ group.name }}{% endblock %}

{% block content %}
<style>
@media (max-width: 768px) { /* Adjust breakpoint as needed */
  .fixed-bottom-right .btn {
    margin-bottom: 10px; /* Add 10px bottom margin to each button on smaller screens */
  }

  .fixed-bottom-right .btn:last-child { /* Remove bottom margin from the last button */
    margin-bottom: 0;
  }
}
</style>
<div class="container">
  <div class="row">
    <div class="col-12">
      <h1>{{ group.name }}</h1>
      <p class="text-muted">{{ group.description }}</p>
      {% for settlement in settlements %}
        {% if settlement[2] == current_user.id %}
          <div class="alert alert-success" role="alert">
            You owe {{ settlement[1] }} ${{ settlement[4]|round(2) }}
          </div>
        {% elif settlement[0] == current_user.id %}
          <div class="alert alert-danger" role="alert">
            {{ settlement[3] }} owes you ${{ settlement[4]|round(2) }}
          </div>
        {% endif %}
    {% endfor %}
    <div class="d-flex d-sm-block mx-5 px-3 px-sm-0 mx-sm-auto flex-column">
      <a href="{{ url_for('views.add_expense', group_id=group.id) }}" 
         class="btn btn-primary btn-lg my-1"> 
        <i class="fas fa-plus"></i> Add Expense
      </a>
      <a href="{{ url_for('views.invite_to_group', group_id=group.id) }}" 
         class="btn btn-lg btn-green my-1"> 
        <i class="fas fa-envelope"></i> Invite to Group
      </a>
      <button type="button" class="btn btn-danger btn-lg my-1" onclick="leaveGroup({{ group.id }})">Leave Group
      </button>
    </div>
    </div>
  </div>

  <h2>Balances Summary</h2>
  <div class="row">
    {% for member in group.members %}
        {% if member.id in balances %}
            <div class="col-md-6 mb-3">
            <div class="card">
                <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="card-title">{{ member.first_name }} {{ member.last_name }}</h5>
                    <p class="card-text">Balance: ${{ balances[member.id] | round(2, 'common') }}</p>
                </div>
                {% if balances[member.id] > 0 %}
                    <span class="badge bg-success">Owed</span>
                {% elif balances[member.id] < 0 %}
                    <span class="badge bg-danger">Owes</span>
                {% else %}
                    <span class="badge bg-secondary">Settled Up</span>
                {% endif %}
                </div>
            </div>
            </div>
        {% endif %}
    {% endfor %}
  </div>

  <h2>Expenses</h2>

  <div class="accordion" id="expenseAccordion">
    {% for expense in expenses %}
      <div class="accordion-item">
        <h2 class="accordion-header" id="heading-{{ expense.id }}">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                  data-bs-target="#collapse-{{ expense.id }}" aria-expanded="false" aria-controls="collapse-{{ expense.id }}">
            {{ expense.description }}: ${{ expense.formatted_amount() }}
          </button>
        </h2>
        <div id="collapse-{{ expense.id }}" class="accordion-collapse collapse" aria-labelledby="heading-{{ expense.id }}" data-bs-parent="#expenseAccordion">
          <div class="accordion-body">
            <p>Paid by: {{ expense.paid_by.first_name }} {{ expense.paid_by.last_name }}</p>
            <p>Date: {{ expense.date.strftime('%Y-%m-%d') }}</p>
            <p>Participants:</p>
            <ul>
              {% for participant in expense.participants %}
                <li>{{ participant.first_name }} {{ participant.last_name }}</li>
              {% endfor %}
            </ul>
            <div class="mt-3">
                <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#editExpenseModal-{{ expense.id }}">Edit</button>
                {% if current_user == expense.paid_by %}
                <a href="#" class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteExpenseModal-{{ expense.id }}" >Delete</a>
                    <div class="modal fade" id="deleteExpenseModal-{{ expense.id }}" tabindex="-1" aria-labelledby="deleteExpenseModalLabel-{{ expense.id }}" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="deleteExpenseModalLabel-{{ expense.id }}">Confirm Delete</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            Are you sure you want to delete this expense?
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <form method="POST" action="{{ url_for('views.delete_expense', expense_id=expense.id) }}">
                            <button type="submit" class="btn btn-danger">Delete</button>
                            </form>
                        </div>
                        </div>
                    </div>
                    </div>
                {% endif %}
            </div>
            <div class="modal fade" id="editExpenseModal-{{ expense.id }}" tabindex="-1" aria-labelledby="editExpenseModalLabel-{{ expense.id }}" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title" id="editExpenseModalLabel-{{ expense.id }}">Edit Expense</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                      <form id="editExpenseForm-{{ expense.id }}" method="POST" action="{{ url_for('views.edit_expense', expense_id=expense.id) }}">
                        <div class="mb-3">
                          <label for="description" class="form-label">Description</label>
                          <input type="text" class="form-control" id="description" name="description" value="{{ expense.description }}" required>
                        </div>
                        <div class="mb-3">
                          <label for="amount" class="form-label">Amount</label>
                          <input type="number" step="0.01" class="form-control" id="amount" name="amount" value="{{ expense.amount }}" step="0.01" min="0.01" required>
                        </div>
                        <div class="mb-3">
                          <label for="participants" class="form-label">Participants</label>
                          {% for member in group.members %}
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="participants" value="{{ member.id }}" id="participant-{{ member.id }}" 
                                   {% if member in expense.participants %}checked{% endif %}>
                            <label class="form-check-label" for="participant-{{ member.id }}">
                              {{ member.first_name }} {{ member.last_name }}
                            </label>
                          </div>
                          {% endfor %}
                        </div>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                      </form>
                    </div>
                  </div>
                </div>
              </div>
              
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
  <!-- <div class="text-center mt-3" id="load-more-container" style="display: {% if more_expenses %}block{% else %}none{% endif %};"> 
    <button class="btn btn-secondary" id="load-more-btn">Load More</button>
  </div> -->
</div>
<!-- The commented out script is used to implement the load more items button-->
<!-- <script>
    // Function to load more expenses
    const loadMoreBtn = document.getElementById('load-more-btn');
    const loadMoreContainer = document.getElementById('load-more-container');
    let currentPage = 1; // Track the current page

    // Handles clicking "Load More" button
    document.addEventListener('click', function(event) {
    if (event.target && event.target.id === 'load-more-btn') { 
        event.preventDefault();
        currentPage++; 
        fetch(`/group/{{ group.id }}/expenses?page=${currentPage}`) 
            .then(response => response.json())
            .then(data => {
                if (data.expenses.length > 0) {
                data.expenses.forEach(expense => {
                    addExpenseToAccordion(expense); 
                });
                } else {
                loadMoreContainer.style.display = 'none';
                }
            });
    }
});
    
    // Function to add an expense to the accordion (similar to addItemToTable)
    function addExpenseToAccordion(expense) {
      // Create the accordion item HTML using expense data
      let accordionItem = `
        <div class="accordion-item">
          <h2 class="accordion-header" id="heading-${expense.id}">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-${expense.id}" aria-expanded="false" aria-controls="collapse-${expense.id}">
              ${expense.description} - $${expense.amount}
            </button>
          </h2>
          <div id="collapse-${expense.id}" class="accordion-collapse collapse" aria-labelledby="heading-${expense.id}" data-bs-parent="#expenseAccordion">
            <div class="accordion-body">
              <p>Paid by: ${expense.paid_by.first_name} ${expense.paid_by.last_name}</p>
              <p>Date: ${expense.date}</p>
              <p>Participants:</p>
              <ul>
                ${expense.participants.map(participant => `<li>${participant.first_name} ${participant.last_name}</li>`).join('')}
              </ul>
              <div class="mt-3">
                <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#editExpenseModal-${expense.id}">Edit</button>
                <a href="/expense/${expense.id}/delete" class="btn btn-sm btn-outline-danger" onclick="return confirm('Are you sure you want to delete this expense?')">Delete</a>
              </div>
              
            </div>
          </div>
        </div>
      `;
    
      expenseAccordion.innerHTML += accordionItem; // Append the new accordion item
    }
    
    </script> -->
    {% if balances[current_user.id] < 0 %}
    <div class="text-center" style="margin: 20px auto; width: fit-content;"> 
      <button type="button" class="btn btn-secondary" onclick="settleUp()">Settle Up Now</button> 
    </div>
    {% endif %}
    <script>
      const currentGroupId = {{ group.id }};
      function settleUp() {
        fetch(`/api/group/${currentGroupId}/settle_up`, {
          method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Refresh the page or update balances dynamically
            location.reload(); 
            $('#settleUpModal').modal('hide'); // Close the modal
          } else {
            alert("Error settling up. Please try again.");
          }
        })
        .catch(error => {
          console.error("Error settling up:", error);
          // Handle error appropriately
        });
      }
      function leaveGroup(groupId) {
    fetch(`/api/leave_group/${groupId}`, {
      method: "POST",
    })
      .then((response) => {
        if (response.ok) {
          window.location.href = "{{ url_for('views.dashboard') }}";
        } else {
          alert("Error leaving group.");
        }
      });
  }
  </script>
{% endblock %}
