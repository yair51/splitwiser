{% extends "base.html" %}

{% block title %}{{ group.name }}{% endblock %}

{% block content %}

<div class="container">
    <h1>{{ group.name }}</h1>
    <p>{{ group.description }}</p>

    <div class="mb-3 d-flex justify-content-between">
        <a href="{{ url_for('views.add_expense', group_id=group.id) }}" class="btn btn-primary">
            Add Expense
        </a>
        <div id="leaveGroupContainer">
            <button class="btn btn-danger" id="leaveGroupBtn" onclick="confirmLeaveGroup({{ group.id }})">Leave Group</button> 
            <div id="leaveConfirmation" class="modal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Confirm Leave Group</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <p>Are you sure you want to leave this group?</p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-danger" data-bs-dismiss="modal">No</button>
                            <button type="button" class="btn btn-success" onclick="leaveGroup({{ group.id }})">Yes</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <h2>Expenses</h2>
    <table class="table">
        <thead>
            <tr>
                <th>Description</th>
                <th>Amount</th>
                <th>Date</th>
                <th>Paid By</th>
            </tr>
        </thead>
        <tbody>
            {% for expense in expenses %}
                <tr>
                    <td>{{ expense.description }}</td>
                    <td>${{ expense.amount }}</td>
                    <td>{{ expense.date.strftime('%Y-%m-%d') }}</td>
                    <td>{{ expense.paid_by.first_name }} {{ expense.paid_by.last_name }}</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>

    <h2>Balances</h2>
    <table class="table">
        <thead>
            <tr>
                <th>Member</th>
                <th>Balance</th>
            </tr>
        </thead>
        <tbody>
            {% for member in group.members %}
                {% if member.id in balances %}
                    <tr>
                        <td>{{ member.first_name }} {{ member.last_name }}</td>
                        <td>${{ balances[member.id] }}</td>
                    </tr>
                {% endif %}
            {% endfor %}
        </tbody>
    </table>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Existing JavaScript for expenses, payments etc.

    function confirmLeaveGroup(groupId) {
        const leaveModal = new bootstrap.Modal(document.getElementById('leaveConfirmation'));
        leaveModal.show();
    }

    function hideLeaveConfirmation() {
        document.getElementById('leaveConfirmation').style.display = 'none';
    }

    function leaveGroup(groupId) {
        fetch(`/api/leave_group/${groupId}`, {
            method: 'POST'
        })
        .then(response => {
            if (response.ok) {
                window.location.href = '{{ url_for("views.dashboard") }}'; 
            } else {
                alert('Error leaving group.'); 
            }
        });
    }
</script>

{% endblock %}